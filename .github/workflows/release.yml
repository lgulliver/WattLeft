name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build-release:
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: xcodegen

      - name: Build
        run: xcodebuild -project WattLeft.xcodeproj -scheme WattLeft -configuration Release -destination "platform=macOS" CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO build

      - name: Package DMG
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          APP_PATH=$(xcodebuild -showBuildSettings -project WattLeft.xcodeproj -scheme WattLeft -configuration Release | awk -F' = ' '/TARGET_BUILD_DIR/ {dir=$2} /WRAPPER_NAME/ {name=$2} END {print dir "/" name}')
          DMG_DIR=$(mktemp -d)
          DMG_RW_PATH="$RUNNER_TEMP/WattLeft-rw.dmg"
          DMG_FINAL_PATH="WattLeft-${VERSION}.dmg"
          MOUNT_DIR="$RUNNER_TEMP/WattLeft-mount"
          BG_DIR="$DMG_DIR/.background"
          ICON_SRC="assets/Icon-iOS-Default-1024x1024@1x.png"

          mkdir -p "$BG_DIR"
          cp -R "$APP_PATH" "$DMG_DIR/WattLeft.app"
          ln -s /Applications "$DMG_DIR/Applications"

          if [ -f "$ICON_SRC" ]; then
            sips -z 280 280 "$ICON_SRC" --out "$BG_DIR/dmg-background.png"
            sips --padToHeightWidth 400 640 "$BG_DIR/dmg-background.png"
          fi

          # Prefer the compiled app icon if available; otherwise build from PNGs
          APP_ICON_PATH="$APP_PATH/Contents/Resources/AppIcon.icns"
          if [ -f "$APP_ICON_PATH" ]; then
            cp "$APP_ICON_PATH" "$DMG_DIR/.VolumeIcon.icns"
          elif [ -f "$ICON_SRC" ]; then
            ICONSET_DIR="$RUNNER_TEMP/WattLeftIcon.iconset"
            mkdir -p "$ICONSET_DIR"
            sips -z 16 16 "$ICON_SRC" --out "$ICONSET_DIR/icon_16x16.png"
            sips -z 32 32 "$ICON_SRC" --out "$ICONSET_DIR/icon_16x16@2x.png"
            sips -z 32 32 "$ICON_SRC" --out "$ICONSET_DIR/icon_32x32.png"
            sips -z 64 64 "$ICON_SRC" --out "$ICONSET_DIR/icon_32x32@2x.png"
            sips -z 128 128 "$ICON_SRC" --out "$ICONSET_DIR/icon_128x128.png"
            sips -z 256 256 "$ICON_SRC" --out "$ICONSET_DIR/icon_128x128@2x.png"
            sips -z 256 256 "$ICON_SRC" --out "$ICONSET_DIR/icon_256x256.png"
            sips -z 512 512 "$ICON_SRC" --out "$ICONSET_DIR/icon_256x256@2x.png"
            sips -z 512 512 "$ICON_SRC" --out "$ICONSET_DIR/icon_512x512.png"
            cp "$ICON_SRC" "$ICONSET_DIR/icon_512x512@2x.png"
            iconutil -c icns "$ICONSET_DIR" -o "$DMG_DIR/.VolumeIcon.icns"
          fi

          hdiutil create -volname "WattLeft" -srcfolder "$DMG_DIR" -ov -format UDRW "$DMG_RW_PATH"
          hdiutil attach "$DMG_RW_PATH" -nobrowse -mountpoint "$MOUNT_DIR"

          xcrun SetFile -a C "$MOUNT_DIR"
          xcrun SetFile -a V "$MOUNT_DIR/.VolumeIcon.icns"

          if [ -z "$GITHUB_ACTIONS" ]; then
            osascript \
              -e 'tell application "Finder"' \
              -e 'tell disk "WattLeft"' \
              -e 'open' \
              -e 'set current view of container window to icon view' \
              -e 'set toolbar visible of container window to false' \
              -e 'set statusbar visible of container window to false' \
              -e 'set the bounds of container window to {100, 100, 740, 500}' \
              -e 'set viewOptions to the icon view options of container window' \
              -e 'set arrangement of viewOptions to not arranged' \
              -e 'set icon size of viewOptions to 128' \
              -e 'set background picture of viewOptions to file ".background:dmg-background.png"' \
              -e 'set position of item "WattLeft.app" to {180, 260}' \
              -e 'set position of item "Applications" to {460, 260}' \
              -e 'close' \
              -e 'end tell' \
              -e 'end tell'
          fi

          hdiutil detach "$MOUNT_DIR"
          hdiutil convert "$DMG_RW_PATH" -format UDZO -o "$DMG_FINAL_PATH"

      - name: Package ZIP
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          APP_PATH=$(xcodebuild -showBuildSettings -project WattLeft.xcodeproj -scheme WattLeft -configuration Release | awk -F' = ' '/TARGET_BUILD_DIR/ {dir=$2} /WRAPPER_NAME/ {name=$2} END {print dir "/" name}')
          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "WattLeft-${VERSION}.zip"

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            WattLeft-*.dmg
            WattLeft-*.zip
          body: |
            This app is distributed unsigned (no Apple Developer ID).

            If macOS blocks the app:
            1) Right-click WattLeft.app and choose Open.
            2) Click Open in the prompt.
